<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Edit Blog</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/pixel.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body { margin: 40px; }
    input, textarea { width: 100%; margin-bottom: 15px; padding: 8px; }
    .existing-photo { position: relative; margin-bottom: 10px; }
    .existing-photo img { max-height: 150px; border: 2px solid var(--px-dark); }
    .delete-checkbox { 
      position: absolute; 
      top: 5px; 
      left: 5px; 
      transform: scale(1.5);
    }
    #preview img { max-width: 100%; margin-top: 0; }
    .position-relative { position: relative; }
    .position-absolute { position: absolute; top: 0; right: 0; }
  </style>
</head>
<body>

<%- include('partials/navbar', { user: user, showBackButton: true }) %>

<div class="container mt-3">
  <h2>Edit Blog</h2>
  
  <form method="post" action="/posts/<%= post._id %>?_method=PUT" enctype="multipart/form-data">
    <label>Title:</label>
    <input class="form-control" name="title" value="<%= post.title %>" required>
    
    <label>Body:</label>
    <textarea class="form-control" rows="8" name="body" required><%= post.body %></textarea>
    
    <% if (post.image && post.image.length > 0) { %>
      <div class="mt-3">
        <label>Existing Photos (check to delete):</label>
        <div class="row g-2 mt-2">
          <% post.image.forEach((img, index) => { %>
            <div class="col-4 col-md-3 position-relative existing-photo">
              <input type="checkbox" name="deletePhotos" value="<%= index %>" 
                     class="delete-checkbox" id="del-<%= index %>">
              <label for="del-<%= index %>">
                <img src="/posts/image/<%= post._id %>/<%= index %>" class="img-thumbnail" 
                     style="width:100%;height:120px;object-fit:cover;">
              </label>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>
    
    <div class="mt-3">
      <label>Add New Photos (max 5):</label>
      <input type="file" name="image" accept="image/*" multiple max="5" id="imgInput">
      <div id="preview" class="row g-2 mt-2"></div>
    </div>
    
    <button class="btn btn-success mt-3">Update</button>
  </form>
</div>

<script>
  const imgInput = document.getElementById('imgInput');
  const preview = document.getElementById('preview');
  const dt = new DataTransfer();

  imgInput.addEventListener('change', () => {
    const selectedFiles = Array.from(imgInput.files);
    const currentCount = dt.items.length;
    const newTotalCount = currentCount + selectedFiles.length;

    const existingCount = <%= post.image ? post.image.length : 0 %>;
    const maxAllowed = 5 - existingCount;
    if (newTotalCount > maxAllowed) {
      alert(`You can only have total 5 photos (you have ${existingCount} now, can add ${maxAllowed} more)`);
      imgInput.value = '';
      return;
    }

    selectedFiles.forEach(f => dt.items.add(f));
    renderPreview();
    syncInput();
  });

  function renderPreview() {
    preview.innerHTML = '';
    Array.from(dt.files).forEach((file, idx) => {
      const col = document.createElement('div');
      col.className = 'col-4 col-md-3 position-relative';
      col.innerHTML = `
        <img src="${URL.createObjectURL(file)}" class="img-thumbnail" style="object-fit:contain;height:120px;width:100%;">
        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" onclick="removeFile(${idx})">Ã—</button>
      `;
      preview.appendChild(col);
    });
  }

  function removeFile(index) {
    dt.items.remove(index);
    renderPreview();
    syncInput();
  }

  function syncInput() {
    imgInput.files = dt.files;
  }
</script>

</body>
</html>
