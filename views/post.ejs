<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title><%= post.title %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/pixel.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>

<%- include('partials/navbar', { user: user, showBackButton: true }) %>

<div class="container mt-3">
  <% if (post.image && post.image.length > 0) { %>
    <% post.image.forEach((img, i) => { %>
      <img src="/posts/image/<%= post._id %>/<%= i %>" class="post-img" alt="photo <%= i+1 %>">
    <% }) %>
  <% } %>

  <h1><%= post.title %></h1>
  <p>AuthorÔºö<%= post.author.username %> | <%= post.createdAt.toLocaleString() %></p>
  <div class="post-body comment-content"><%= post.body %></div>
<div class="mt-4">
  <%
  const userId = user._id.toString();
  const hasLiked = post.likes && post.likes.includes(userId);
  const hasDisliked = post.dislikes && post.dislikes.includes(userId);
  %>
  
  <form action="/posts/<%= post._id %>/like" method="post" style="display:inline;">
    <button class="btn btn-sm <%= hasLiked ? 'btn-success' : 'btn-outline-success' %>">
      üëç <%= post.likes ? post.likes.length : 0 %>
    </button>
  </form>
  
  <form action="/posts/<%= post._id %>/dislike" method="post" style="display:inline; margin-left: 10px;">
    <button class="btn btn-sm <%= hasDisliked ? 'btn-danger' : 'btn-outline-danger' %>">
      üëé <%= post.dislikes ? post.dislikes.length : 0 %>
    </button>
  </form>
</div>

<hr>
  <hr>

  <!-- comment -->
  <h3>Send comment</h3>
  <form action="/comments" method="POST" enctype="multipart/form-data">
    <textarea name="content" rows="3" placeholder="Write something..." required></textarea>
    <input type="file" name="image" accept="image/*">
    <input type="hidden" name="post" value="<%= post._id %>">
    <button type="submit" class="btn btn-primary btn-sm">Send comment</button>
  </form>

  <hr>

  <h3>CommentÔºà<%= comments.length %>Ôºâ</h3>

  <% function printComments(list, isSub = false) { %>
  <% list.forEach(c => { %>
    <div class="comment">
      <% if (user && user._id.toString() === c.author._id.toString()) { %>
        <form action="/comments/<%= c._id %>?_method=DELETE" method="post" class="del-btn"
              onsubmit="return confirm('Delete this comment?')">
          <button class="btn btn-sm btn-outline-danger">√ó</button>
        </form>
      <% } %>

      <strong><%= c.author.username %></strong>
      <span class="text-muted"> - <%= c.createdAt.toLocaleString() %></span>
      <p class="comment-content"><%= c.content %></p>

      <% if (c.image && c.image.data) { %>
        <img class="comment-img" src="/comments/image/<%= c._id %>" alt="comment photo">
      <% } %>

      <% if (c.replies && c.replies.length) { %>
        <div class="reply">
          <%
          const showInitial = 3;
          const hasMore = c.replies.length > showInitial;
          let replyIndex = 0;
          %>
          <% c.replies.forEach((reply) => { %>
            <% if (hasMore && replyIndex === showInitial) { %>
              <button class="btn btn-sm btn-outline-warning toggle-replies mb-2" 
                      onclick="toggleReplies(this)" 
                      data-shown="false"
                      data-count="<%= c.replies.length - showInitial %>">
                Show all <%= c.replies.length - showInitial %> replies
              </button>
              <div class="extra-replies" style="display: none;">
            <% } %>
            <% printComments([reply], true); %>
            <% replyIndex++; %>
          <% }) %>
          <% if (hasMore) { %>
              </div>
          <% } %>
        </div>
      <% } %>

      <% if (!isSub) { %>
        <form action="/comments" method="POST" class="mt-2">
          <input type="hidden" name="post" value="<%= post._id %>">
          <input type="hidden" name="parent" value="<%= c._id %>">
          <textarea name="content" rows="2" placeholder="reply..." required></textarea>
          <button type="submit" class="btn btn-sm btn-outline-primary">Reply</button>
        </form>
      <% } %>
    </div>
  <% }) %>
<% } %>

  <% printComments(comments, false) %>

<hr>	

</div>


<script>
  function toggleReplies(button) {
    const extraReplies = button.nextElementSibling;
    const isShown = button.dataset.shown === 'true';
    const count = button.dataset.count;
    
    if (isShown) {
      extraReplies.style.display = 'none';
      button.textContent = `Show all ${count} replies`;
      button.dataset.shown = 'false';
    } else {
      extraReplies.style.display = 'block';
      button.textContent = 'Hide replies';
      button.dataset.shown = 'true';
    }
  }
</script>
</body>
</html>

</body>
</html>
